<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQLMap 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="mrpGathering">

	<typeAlias alias="MrpGatheringTO" type="com.estimulo.logistics.production.to.MrpGatheringTO"/>
	
	<resultMap class="MrpGatheringTO" id="mrpGatheringListResult">
		<result property="mrpGatheringNo" column="MRP_GATHERING_NO"  />
		<result property="orderOrProductionStatus" column="ORDER_OR_PRODUCTION_STATUS"  />
		<result property="itemCode" column="ITEM_CODE"  />
		<result property="itemName" column="ITEM_NAME"  />
		<result property="unitOfMrpGathering" column="UNIT_OF_MRP_GATHERING"  />
		<result property="claimDate" column="CLAIM_DATE"  />
		<result property="dueDate" column="DUE_DATE"  />
		<result property="necessaryAmount" column="NECESSARY_AMOUNT" />
	</resultMap>
	
	<resultMap class="mrpGatheringTO" id="mrpGatheringResult" >
		<result property="orderOrProductionStatus" column="ORDER_OR_PRODUCTION_STATUS"  />
		<result property="itemCode" column="ITEM_CODE"  />
		<result property="itemName" column="ITEM_NAME"  />
		<result property="unitOfMrpGathering" column="UNIT_OF_MRP_GATHERING"  />
		<result property="claimDate" column="CLAIM_DATE"  />
		<result property="dueDate" column="DUE_DATE"  />
		<result property="necessaryAmount" column="NECESSARY_AMOUNT"  />
	</resultMap>
	
	<select id="selectMrpGatheringList" parameterClass="map" resultMap="mrpGatheringListResult">
		SELECT * FROM MRP_GATHERING WHERE ( CASE #searchDateCondition# WHEN 'claimDate' THEN
				TO_DATE(CLAIM_DATE, 'YYYY-MM-DD') WHEN 'dueDate' THEN
				TO_DATE(DUE_DATE, 'YYYY-MM-DD') END ) 
				BETWEEN TO_DATE(#startDate#,'YYYY-MM-DD') AND TO_DATE(#endDate#,'YYYY-MM-DD')
	</select>
	
	<select id="getMrpGathering" parameterClass="String" resultMap="mrpGatheringResult">
		<![CDATA[
		SELECT ORDER_OR_PRODUCTION_STATUS
				,ITEM_CODE
				,ITEM_NAME
				,UNIT_OF_MRP_GATHERING		
				,CLAIM_DATE
				,DUE_DATE
				,SUM(NECESSARY_AMOUNT) AS NECESSARY_AMOUNT
		FROM  (SELECT DECODE(item_classification,'원재료','구매','생산') AS ORDER_OR_PRODUCTION_STATUS 
					,ITEM_CODE 
					,TRIM(ITEM_NAME) AS ITEM_NAME 
					,UNIT_OF_MRP AS UNIT_OF_MRP_GATHERING
					,MIN(ORDER_DATE)      AS CLAIM_DATE 
					,MIN(REQUIRED_DATE)   AS DUE_DATE 
					,SUM(REQUIRED_AMOUNT) AS NECESSARY_AMOUNT
					FROM   mrp
					WHERE  mrp_gathering_no IS NULL
					AND    MRP_NO IN ( WITH MRP_NO_STR AS
					                    (SELECT #mrpNoList# AS STR
					                    FROM    DUAL)
								            SELECT   TRIM(REGEXP_SUBSTR(MRP_NO_STR.STR,'[^,]+',1,LEVEL)) AS MRP_NO
								            FROM     MRP_NO_STR
								            CONNECT BY LEVEL <= REGEXP_COUNT(STR,'[^,]+',1) )
		  GROUP BY ITEM_CLASSIFICATION 
		  				,ITEM_CODE 
		  				,ITEM_NAME 
		  				,UNIT_OF_MRP
		  ORDER BY CLAIM_DATE 
		  				,ORDER_OR_PRODUCTION_STATUS)
		  GROUP BY ITEM_CODE,ITEM_NAME,ORDER_OR_PRODUCTION_STATUS,UNIT_OF_MRP_GATHERING,CLAIM_DATE,DUE_DATE
		  ORDER BY CLAIM_DATE
		]]>
	</select>
	
	<resultMap class="MrpGatheringTO" id="mrpGatheringNoResult">
		<result property="mrpGatheringNo" column="MRP_GATHERING_NO"  />		
	</resultMap>
	
	<select id="selectMrpGatheringCount" parameterClass="String" resultMap="mrpGatheringNoResult">
		<![CDATA[
		SELECT * FROM MRP_GATHERING 
			WHERE INSTR(MRP_GATHERING_NO, REPLACE( #mrpGatheringRegisterDate# , '-' , '' ) ) > 0
		]]>
	</select>
	
	<insert id="insertMrpGathering" parameterClass="MrpGatheringTO">
		Insert into MRP_GATHERING 
			( MRP_GATHERING_NO, ORDER_OR_PRODUCTION_STATUS, ITEM_CODE, ITEM_NAME,
			UNIT_OF_MRP_GATHERING, CLAIM_DATE, DUE_DATE, NECESSARY_AMOUNT, MRP_GATHERING_SEQ ) 				
			values ( #mrpGatheringNo#, #orderOrProductionStatus#, 
					 #itemCode#, #itemName#, #unitOfMrpGathering#,
					 #claimDate#, #dueDate#, #necessaryAmount# ,#mrpGatheringSeq#
					) 				 	
	</insert>
	
	<update id="updateMrpGathering" parameterClass="MrpGatheringTO">
		UPDATE MRP_GATHERING SET 
				ITEM_CODE = #itemCode# , ITEM_NAME = #itemName# , UNIT_OF_MRP_GATHERING = #unitOfMrpGathering# , 
				NECESSARY_AMOUNT = #necessaryAmount# , DUE_DATE = #dueDate# , CLAIM_DATE = #claimDate#, 
				ORDER_OR_PRODUCTION_STATUS = #orderOrProductionStatus# 
				WHERE MRP_GATHERING_NO = #mrpGatheringNo#
	</update>
	
	<delete id="deleteMrpGathering" parameterClass="MrpGatheringTO">
		DELETE FROM MRP_GATHERING WHERE MRP_GATHERING_NO = #mrpGatheringNo#
	</delete>
	
	<parameterMap class="map" id="updateMrpGatheringContractParameter">
		<parameter property="mrpGatheringNo" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
		<parameter property="ERROR_CODE" javaType="java.lang.Integer" jdbcType="DECIMAL" mode="OUT" />
		<parameter property="ERROR_MSG" javaType="java.lang.String" jdbcType="VARCHAR" mode="OUT" />
	</parameterMap>
	
	<procedure id="updateMrpGatheringContract" parameterMap="updateMrpGatheringContractParameter">
		<![CDATA[
			{call P_MRP_GATHERING_CONTRACT(?,?,?)}
		]]>
	</procedure>
	
	<select id="getMGSeqNo" resultClass="int">
			SELECT MRP_GATHERING_SEQ.NEXTVAL FROM DUAL
	</select>
</sqlMap>