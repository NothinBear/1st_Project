<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQLMap 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="mrp">
	<typeAlias alias="MrpTO" type="com.estimulo.logistics.production.to.MrpTO"/>
	
	<resultMap class="MrpTO" id="mrpResult">
		<result property="mrpNo" column="MRP_NO"  />
		<result property="mpsNo" column="MPS_NO"  />
		<result property="mrpGatheringNo" column="MRP_GATHERING_NO"  />
		<result property="itemClassification" column="ITEM_CLASSIFICATION"  />
		<result property="itemCode" column="ITEM_CODE"  />
		<result property="itemName" column="ITEM_NAME"  />
		<result property="unitOfMrp" column="UNIT_OF_MRP"  />
		<result property="requiredAmount" column="REQUIRED_AMOUNT" />
		<result property="orderDate" column="ORDER_DATE"  />
		<result property="requiredDate" column="REQUIRED_DATE"  />
		<result property="mrpGatheringStatus" column="MRP_GATHERING_STATUS"  />
	</resultMap>
	
	<typeAlias alias="OpenMrpTO" type="com.estimulo.logistics.production.to.OpenMrpTO"/>
	
	<resultMap class="OpenMrpTO" id="openMrpResult">			
		<result property="mpsNo" column="MPS_NO"  />
		<result property="bomNo" column="BOM_NO"  />
		<result property="itemClassification" column="ITEM_CLASSIFICATION"  />
		<result property="itemCode" column="ITEM_CODE"  />
		<result property="itemName" column="ITEM_NAME"  />
		<result property="orderDate" column="ORDER_DATE"  />
		<result property="requiredDate" column="REQUIRED_DATE"  />
		<result property="planAmount" column="PLAN_AMOUNT"  />
		<result property="totalLossRate" column="TOTAL_LOSS_RATE"  />
		<result property="caculatedAmount" column="CACULATED_AMOUNT"  />
		<result property="requiredAmount" column="REQUIRED_AMOUNT" />
		<result property="unitOfMrp" column="UNIT_OF_MRP"  />			
	</resultMap>
	
	<select id="selectMrpList" parameterClass="map" resultMap="mrpResult">
		SELECT * FROM MRP 

	<dynamic prepend="WHERE ">

		<isEqual property="mrpGatheringStatusCondition" compareValue="null" close=" ">
			MRP_GATHERING_STATUS IS NULL
		</isEqual>

		<isEmpty property="mrpGatheringStatusCondition" close=" ">
			MRP_GATHERING_STATUS IS NULL
		</isEmpty>

		<isEqual property="mrpGatheringStatusCondition" compareValue="notNull" close=" ">
			MRP_GATHERING_STATUS IS NOT NULL
		</isEqual>

	</dynamic>

	ORDER BY MRP_NO
	</select>
	
	<select id="selectMrpListAsDate" parameterClass="map" resultMap="mrpResult">
		SELECT * FROM MRP WHERE ( CASE #dateSearchCondition# WHEN 'orderDate' THEN 
              TO_DATE(ORDER_DATE, 'YYYY-MM-DD') WHEN 'requiredDate' THEN
              TO_DATE(REQUIRED_DATE, 'YYYY-MM-DD') END )  
              BETWEEN TO_DATE(#startDate#,'YYYY-MM-DD') AND TO_DATE(#endDate#,'YYYY-MM-DD')
	</select>
	
	<select id="selectMrpListAsMrpGatheringNo" parameterClass="String" resultMap="mrpResult">
		SELECT * FROM MRP WHERE MRP_GATHERING_NO = #mrpGatheringNo#
	</select>
	
	<parameterMap class="map" id="openMrpParameter">
		<parameter property="mpsNoList" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
		<parameter property="ERROR_CODE" javaType="java.lang.Integer" jdbcType="DECIMAL" mode="OUT" />
		<parameter property="ERROR_MSG" javaType="java.lang.String" jdbcType="VARCHAR" mode="OUT" />
		<parameter property="RESULT" javaType="java.sql.ResultSet" jdbcType="ORACLECURSOR" mode="OUT" />
	</parameterMap>
	
	<procedure id="openMrp" parameterMap="openMrpParameter" resultMap="openMrpResult">
		<![CDATA[ {call P_MRP_OPEN(?,?,?,?)} ]]>
	</procedure>
	
	<resultMap id="mrpNoResult" class="MrpTO">
		<result property="mrpNo" column="MRP_NO" />
	</resultMap>
	
	<select id="selectMrpCount" parameterClass="String" resultMap="mrpNoResult">
		<![CDATA[
			SELECT * FROM MRP WHERE INSTR(MRP_NO, REPLACE( #mrpRegisterDate# , '-' , '' ) ) > 0
		]]>
	</select>
	
	<insert id="insertMrp" parameterClass="MrpTO">
		Insert into MRP
              	(MRP_NO, MPS_NO, MRP_GATHERING_NO, ITEM_CLASSIFICATION, 
              	ITEM_CODE, ITEM_NAME, UNIT_OF_MRP, 
              	REQUIRED_AMOUNT, ORDER_DATE, REQUIRED_DATE,
              	MRP_GATHERING_STATUS)
              	values( #mrpNo#, #mpsNo#, 
              			#mrpGatheringNo#, #itemClassification#,
              			#itemCode#, #itemName#,
              			#unitOfMrp#, #requiredAmount#,
              			#orderDate# , #requiredDate#, #mrpGatheringStatus#
              		  )               	
	</insert>
	
	<update id="updateMrp" parameterClass="MrpTO">
		UPDATE MRP SET MPS_NO = #mpsNo# , MRP_GATHERING_NO = #mrpGatheringNo# ,
              ITEM_CLASSIFICATION = #itemClassification# , ITEM_CODE = #itemCode# ,
              ITEM_NAME = #itemName# , UNIT_OR_MRP = #unitOfMrp# ,
              REQUIRED_AMOUNT = #requiredAmount# , ORDER_DATE = #orderDate# ,
              REQUIRED_DATE = #requiredDate# , MRP_GATHERING_STATUS = #mrpGatheringStatus# 
              WHERE MRP_NO = #mrpNo#
	</update>
	
	<update id="changeMrpGatheringStatus" parameterClass="map">
		UPDATE MRP SET 
			MRP_GATHERING_NO = #mrpGatheringNo# , 
			MRP_GATHERING_STATUS = #mrpGatheringStatus# 
			WHERE MRP_NO = #mrpNo#
	</update>
	
	<delete id="deleteMrp" parameterClass="MrpTO">
		DELETE FROM MRP WHERE MRP_NO = #mrpNo#
	</delete>
	
	<parameterMap class="map" id="insertMrpParamMap">
		<parameter property="mrpRegisterDate" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
		<parameter property="ERROR_CODE" javaType="java.lang.Integer" jdbcType="DECIMAL" mode="OUT" />
		<parameter property="ERROR_MSG" javaType="java.lang.String" jdbcType="VARCHAR" mode="OUT" />
		<parameter property="RESULT" javaType="java.sql.ResultSet" jdbcType="ORACLECURSOR" mode="OUT" />
	</parameterMap>
	<typeAlias alias="MrpInsertInfoTO" type="com.estimulo.logistics.production.to.MrpInsertInfoTO"/>
	<resultMap class="MrpInsertInfoTO" id="resultMrpInsertMap">
		<result property="firstMrpNo" column="FIRST_NO"  />
		<result property="lastMrpNo" column="LAST_NO"  />
		<result property="length" column="LENG"  />
	</resultMap>
	<procedure id="insertMrpList" parameterMap="insertMrpParamMap" resultMap="resultMrpInsertMap">
		<![CDATA[ {call P_INSERT_MRP(?,?,?,?)} ]]>
	</procedure>
	
</sqlMap>